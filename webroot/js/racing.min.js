function Car(e,t){this.img=new Image,this.img.onload=function(){},this.img.src="img/racing/s90.png",this.enginefast=new Audio("sound/engine.mp3"),this.engineslow=new Audio("sound/engine.mp3"),this.tires=new Audio("sound/brake.mp3"),this.horn=new Audio("sound/horn.mp3"),this.turn=new Audio("sound/turn.mp3"),this.crash=new Audio("sound/crash.mp3"),this.revving=new Audio("sound/revving.mp3"),this.collisions={top:new CollisionPoint(this,0),right:new CollisionPoint(this,90,10),bottom:new CollisionPoint(this,180),left:new CollisionPoint(this,270,10)}}function HitMap(e){var t=this;this.img=e,e.complete?this.draw():e.onload=function(){t.draw()}}function CollisionPoint(e,t,i){this.car=e,this.rotation=t,this.distance=i||this.distance}function CollisionRadius(){}function speedXY(e,t){return{x:Math.sin(e*TO_RADIANS)*t,y:Math.cos(e*TO_RADIANS)*t*-1}}function drawRotatedImage(e,t,i,n,s){s.save(),s.translate(t,i),s.rotate(n*TO_RADIANS),s.drawImage(e,-(e.width/2),-(e.height/2)),s.restore()}function rotatePoint(e,t,i){return{x:Math.sin(t*TO_RADIANS)*i+e.x,y:Math.cos(t*TO_RADIANS)*i*-1+e.y}}function distance(e,t){var i=e.x>t.x?e.x-t.x:t.x-e.x,n=e.y>t.y?e.y-t.y:t.y-e.y;return Math.sqrt(Math.pow(i,2)+Math.pow(n,2))}function passedStartline(e,t){return e>657&&716>e&&t>165&&191>t?!0:!1}function passedCheckpoint1(e,t){return e>62&&115>e&&t>354&&390>t?!0:!1}function passedCheckpoint2(e,t){return e>780&&810>e&&t>500&&581>t?!0:!1}function secondsToTimeString(e){if(!e)return"--.--.--";if(e>=0){var t=Math.floor(e/60),i=e%60;return t+"."+i.toFixed(4)}e=Math.abs(e);var t=Math.floor(e/60),i=e%60;return"-"+t+"."+i.toFixed(4)}function stringStartsWith(e,t){return e.slice(0,t.length)==t}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),window.cancelRequestAnimFrame=function(){return window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.clearTimeout}(),window.Key={pressed:{},LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,A:65,S:83,D:68,W:87,R:82,H:72,isDown:function(e,t){return this.pressed[e]||this.pressed[t]},onKeydown:function(e){this.pressed[e.keyCode]=!0},onKeyup:function(e){delete this.pressed[e.keyCode]}},window.addEventListener("keyup",function(e){Key.onKeyup(e)},!1),window.addEventListener("keydown",function(e){Key.onKeydown(e)},!1),Car.prototype={x:740,y:320,acceleration:1.02,rotation:340,speed:0,speedDecay:.99,maxSpeed:3.9,rotationStep:2,backSpeed:1.01,lapstarttime:0,checkpoint1:!1,checkpoint2:!1,lap:null,lastlap:null,diff:null,bestlap:null,numlaps:0,isMoving:function(e){return!(this.speed>-.4&&this.speed<.4)},getCenter:function(){return{x:this.x,y:this.y}},accelerate:function(){this.speed<this.maxSpeed&&(this.speed<0?this.speed*=this.speedDecay:0===this.speed?this.speed=.4:(this.speed*=this.acceleration,this.speed>2))},decelerate:function(e){e=e||0,Math.abs(this.speed)<this.maxSpeed&&(this.speed>0?(this.speed*=this.speedDecay,this.speed=this.speed<e?e:this.speed):0===this.speed?this.speed=-.4:(this.speed*=this.backSpeed,this.speed=this.speed>e?e:this.speed))},brake:function(e){e=e||0,Math.abs(this.speed)<this.maxSpeed&&(this.speed>0?(this.speed*=this.speedDecay-.01,this.speed=this.speed<e?e:this.speed,this.tires.play()):0===this.speed&&(this.speed=0))},steerLeft:function(){this.isMoving()&&(this.rotation-=this.rotationStep/1.5+this.speed/this.maxSpeed,this.turn.play())},steerRight:function(){this.isMoving()&&(this.rotation+=this.rotationStep/1.5+this.speed/this.maxSpeed,this.turn.play())},honk:function(){this.horn.play()}},HitMap.prototype={draw:function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.img.width,this.canvas.height=this.img.height,this.ct=this.canvas.getContext("2d"),this.ct.drawImage(this.img,0,0)},isHit:function(e,t){if(this.ct){var i=this.ct.getImageData(e,t,1,1);return 0===i.data[0]?!0:!1}return!1},crashes:function(e,t){if(this.ct){var i=this.ct.getImageData(e,t,1,1);return 0===i.data[1]?!0:!1}return!1}},CollisionPoint.prototype={car:null,rotation:0,distance:20,getXY:function(){return rotatePoint(this.car.getCenter(),this.car.rotation+this.rotation,this.distance)},isHit:function(e){var t=this.getXY();return e.isHit(t.x,t.y)},crashes:function(e){var t=this.getXY();return e.crashes(t.x,t.y)}},CollisionRadius.prototype={x:0,y:0,radius:10,check:function(e){}};var TO_RADIANS=Math.PI/180;window.Racing=function(){var e,t,i,n,s,a,o,r,d,p,c,h,l,u=function(s){s=document.getElementById(s),e=s.getContext("2d"),a=s.width,o=s.height,t=new Car,i=new Image,r=document.getElementById("lap"),d=document.getElementById("lastlap"),p=document.getElementById("diff"),c=document.getElementById("bestlap"),l=document.getElementById("numlaps"),h=document.getElementById("savelap"),savenumlaps=document.getElementById("savenumlaps"),h?(t.bestlap=h.value,c.innerHTML="Best: "+secondsToTimeString(t.bestlap)):c.innerHTML="Best: --.--.--",savenumlaps?(t.numlaps=savenumlaps.value,l.innerHTML="Laps: "+t.numlaps):(t.numlaps=0,l.innerHTML="Laps: 0"),i.src="img/racing/track-border.png",n=new HitMap(i),console.log("Init the game")},m=function(e){e.isMoving()?e.speed*=e.speedDecay:e.speed=0,Key.isDown(Key.UP,Key.W)&&e.accelerate(),Key.isDown(Key.R,Key.DOWN)&&e.decelerate(),Key.isDown(Key.LEFT,Key.A)&&e.steerLeft(),Key.isDown(Key.RIGHT,Key.D)&&e.steerRight(),Key.isDown(Key.S)&&e.brake(),Key.isDown(Key.H)&&e.honk();var t=speedXY(e.rotation,e.speed);if(e.x+=t.x,e.y+=t.y,e.collisions.left.isHit(n)&&(e.decelerate(1),e.revving.play()),e.collisions.right.isHit(n)&&(e.decelerate(1),e.revving.play()),e.collisions.top.isHit(n)&&(e.decelerate(1),e.revving.play()),e.collisions.bottom.isHit(n)&&(e.decelerate(1),e.revving.play()),e.collisions.left.crashes(n)&&(e.steerRight(),e.speed=0,e.crash.play()),e.collisions.right.crashes(n)&&(e.steerLeft(),e.speed=0,e.crash.play()),e.collisions.top.crashes(n)&&(e.speed=0,e.crash.play()),e.collisions.bottom.crashes(n)&&(e.speed=0,e.crash.play()),passedCheckpoint1(e.x,e.y)&&(console.log("You passed checkpoint 1!"),e.checkpoint1=!0),passedCheckpoint2(e.x,e.y)&&(console.log("You passed checkpoint 2!"),e.checkpoint2=!0),passedStartline(e.x,e.y))if(e.checkpoint1&&e.checkpoint2){var i=Math.round(1e3*new Date)/1e6;e.lastlap=i-e.lapstart;var s=secondsToTimeString(e.lastlap);console.log("You passed the finishline at "+s+"!"),d.innerHTML="Last: "+s,e.numlaps++,savenumlaps&&(savenumlaps.value=e.numlaps),l.innerHTML="Laps: "+e.numlaps,e.checkpoint1=!1,e.checkpoint2=!1,e.lapstart=Math.round(1e3*new Date)/1e6,e.bestlap&&(e.diff=e.lastlap-e.bestlap,diffTimer=secondsToTimeString(e.diff),p.innerHTML=diffTimer,stringStartsWith(diffTimer,"-")?p.className="green":p.className="red"),e.bestlap&&e.lastlap<e.bestlap?(e.bestlap=e.lastlap,c.innerHTML="Best: "+s,h&&(h.value=e.bestlap)):e.bestlap||(e.bestlap=e.lastlap,c.innerHTML="Best: "+s,h&&(h.value=e.bestlap))}else e.lapstart=Math.round(1e3*new Date)/1e6,console.log("You started a new lap");var a=Math.round(1e3*new Date)/1e6;e.lap=a-e.lapstart;var o=secondsToTimeString(e.lap);o?r.innerHTML="Lap: "+o:r.innerHTML="Lap: --.--.--"},w=function(t){e.clearRect(0,0,a,o),drawRotatedImage(t.img,t.x,t.y,t.rotation,e)},g=function(){var e=Date.now();td=(e-(s||e))/1e3,s=Date.now(),requestAnimFrame(g),m(t),w(t)};return{init:u,gameLoop:g}}();